<!doctype html>
<html lang="en">
<head>
    <title>gametube</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <style>
        :root {
            background-color: darkslategray;
        }

        body {
            height: 100dvh;
            width: 100dvw;
            overflow: hidden;
        }

        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
            user-select: none;
        }

        video {
            display: block;
            max-height: 100dvh;
            max-width: 100dvw;
            border: 2px solid red;
        }
    </style>
</head>
<body>
<main id="app">
    <video autoplay id="remoteVideo" muted playsinline></video>
</main>
<script defer>
    const h264Support = RTCRtpReceiver.getCapabilities("video").codecs.some(codec => codec.mimeType === "video/H264");
    if (!h264Support) {
        alert("H.264 codec not supported");
        throw new Error("H.264 codec not supported");
    }

    const videoElement = document.getElementById("remoteVideo");
    if (!videoElement) {
        throw new Error("video element not found");
    }

    videoElement.addEventListener("loadedmetadata", () => {
        console.log("Video metadata loaded", {
            videoWidth: videoElement.videoWidth,
            videoHeight: videoElement.videoHeight,
            readyState: videoElement.readyState
        });
    });
    videoElement.addEventListener("playing", () => {
        console.log("Video playback started");
    });
    videoElement.addEventListener("stalled", () => {
        console.log("Video playback stalled");
    });
    videoElement.addEventListener("error", (e) => {
        console.error("Video error:", videoElement.error);
    });

    const mediaSource = new MediaSource();
    videoElement.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener('sourceopen', () => {
        const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E"');
        const wsUrl = new URL(window.location.href);
        wsUrl.protocol = wsUrl.protocol === "https:" ? "wss:" : "ws:";
        wsUrl.pathname = "/ws";
        wsUrl.hash = "";
        wsUrl.search = "";
        const ws = new WebSocket(wsUrl);

        ws.onclose = () => {
            console.debug("ws close");
        };

        ws.binaryType = 'arraybuffer';

        ws.onmessage = (event) => {
            try {
                sourceBuffer.appendBuffer(event.data);
            } catch (e) {
                console.error('Error appending buffer:', e);
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
        };
    });
</script>
<script defer>
    // const userInputEventNames = ["click", "contextmenu", "auxclick", "dblclick", "mousedown", "mouseup", "pointerup", "touchend", "keydown", "keyup"];
    //
    // function unmuteVideos() {
    //     const videoEls = document.querySelectorAll("video[muted]");
    //     for (const videoEl of Array.from(videoEls)) {
    //         if (videoEl.srcObject) {
    //             videoEl.muted = false;
    //         }
    //     }
    // }
    //
    // for (const eventName of userInputEventNames) {
    //     document.addEventListener(eventName, unmuteVideos);
    // }
</script>
</body>
</html>

